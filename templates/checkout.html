<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Herbs & Spices Store</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #2c5530; margin-bottom: 30px; text-align: center; }
        .checkout-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .form-section, .order-summary { background: #f8f9fa; padding: 20px; border-radius: 8px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .total-section { margin-top: 20px; padding-top: 20px; border-top: 2px solid #2c5530; }
        .total-line { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .grand-total { font-size: 18px; font-weight: bold; color: #2c5530; }
        .btn-primary { background: #2c5530; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; width: 100%; margin-top: 20px; }
        .btn-primary:hover { background: #1e3a23; }
        .btn-primary:disabled { background: #6c757d; cursor: not-allowed; }
        .loading { display: none; text-align: center; margin: 20px 0; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2c5530; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #cce5ff; color: #004085; border: 1px solid #b3d7ff; }
        .mpesa-instructions { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #007bff; }
        .test-info { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Checkout</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != 'message' else 'info' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if cart_items %}
        <div class="checkout-grid">
            <!-- Order Summary -->
            <div class="order-summary">
                <h3>Order Summary</h3>
                {% for item in cart_items %}
                <div class="cart-item">
                    <div class="item-details">
                        <div class="item-name">{{ item.product.name }}</div>
                        <div class="item-price">KES {{ "%.2f"|format(item.product.price) }} x {{ item.quantity }}</div>
                    </div>
                    <div class="item-total">
                        KES {{ "%.2f"|format(item.product.price * item.quantity) }}
                    </div>
                </div>
                {% endfor %}
                
                <div class="total-section">
                    <div class="total-line grand-total">
                        <span>Total:</span>
                        <span>KES {{ "%.2f"|format(total) }}</span>
                    </div>
                </div>

                <div class="test-info">
                    <strong>Test Instructions:</strong><br>
                    - Phone: <strong>254708374149</strong><br>
                    - Amount: <strong>1-100 KES</strong><br>
                    - PIN: <strong>174379</strong>
                </div>
            </div>

            <!-- Payment Form -->
            <div class="form-section">
                <h3>Payment Information</h3>
                
                <div class="mpesa-instructions">
                    <strong>M-Pesa Payment Instructions:</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Enter your M-Pesa registered phone number</li>
                        <li>You will receive an M-Pesa prompt on your phone</li>
                        <li>Enter your M-Pesa PIN to complete payment</li>
                    </ul>
                </div>

                <form id="checkoutForm" method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="form-group">
                        <label for="phone_number">M-Pesa Phone Number *</label>
                        {{ form.phone_number(class="form-control", placeholder="e.g., 254708374149 or 0712345678", required=true, value="254708374149") }}
                        <small style="color: #666;">Use format: 254708374149 or 0712345678</small>
                    </div>

                    <div class="form-group">
                        <label for="shipping_address">Shipping Address *</label>
                        {{ form.shipping_address(class="form-control", placeholder="Enter your complete shipping address", required=true, rows="4") }}
                    </div>

                    <div class="form-group">
                        <label for="notes">Order Notes (Optional)</label>
                        {{ form.notes(class="form-control", placeholder="Any special instructions", rows="3") }}
                    </div>

                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Processing payment... Please wait</p>
                    </div>

                    <button type="submit" class="btn-primary" id="submitBtn">
                        Complete Order with M-Pesa
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            Your cart is empty. <a href="{{ url_for('index') }}">Continue shopping</a>
        </div>
        {% endif %}
    </div>

    <script>
        document.getElementById('checkoutForm').addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            
            // Validate phone number format
            const phoneInput = document.getElementById('phone_number');
            let phoneNumber = phoneInput.value.replace(/\D/g, ''); // Remove non-digits
            
            // Format phone number properly
            if (phoneNumber.startsWith('0') && phoneNumber.length === 10) {
                phoneNumber = '254' + phoneNumber.substring(1);
            } else if (phoneNumber.length === 9) {
                phoneNumber = '254' + phoneNumber;
            }
            
            // Update the input with formatted number
            phoneInput.value = phoneNumber;
            
            // Validate final format
            if (!(phoneNumber.length === 12 && phoneNumber.startsWith('254'))) {
                e.preventDefault();
                alert('Please enter a valid Kenyan phone number (e.g., 0712345678 or 254712345678)');
                phoneInput.focus();
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            loading.style.display = 'block';
        });

        // Auto-format phone number as user types
        document.getElementById('phone_number').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.startsWith('254') && value.length <= 12) {
                e.target.value = value;
            } else if (value.startsWith('0') && value.length <= 10) {
                e.target.value = value;
            } else if (value.length <= 9 && !value.startsWith('0')) {
                e.target.value = value;
            }
        });
    </script>
</body>
</html>
